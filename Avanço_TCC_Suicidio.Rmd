---
title: "Análises Suicídio"
author: "Caroline Assis de Oliveira, 20180011385"
date: "`r format(Sys.time(), '%d de %B de %Y')`"
output: 
  html_document:
    number_section: yes
    toc: yes
encoding: 'utf-8'
---

# Bibliotecas:
```{r, message=F, warning=F}
library(data.table)
library(lubridate)
library(dplyr)
library(rio)
library(survival)
library(muhaz)
library(flexsurv)
library(ranger)
library(ggplot2)
library(ggfortify)
library(tidycmprsk)
library(ggsurvfit)
library(mstate)
library(Rcmdr)
```


# Organização da Base

Todo o processamento foi feito no script `processamento.R`.

```{r, message=F, warning=F}
setwd("~/Suicidio no Brasil-20230703T132807Z-001/Suicidio no Brasil")
base = import('./base_obito_ajustada.xlsx')

attach(base)
```


# Estudos Não-Paramétricos

## Curva de Sobrevivência com Intervalo de Confiança Simétrico

```{r, message=F, warning=F}
ekm = survfit(Surv(IDADEanos,censura_suicidio)~1, data = base)
summary(ekm)

autoplot(ekm) +
  labs(x = "Tempo (anos)",
       y = "S(t) estimada")
```


## Curva de Sobrevivência com Intervalo de Confiança Assimétrico
```{r}
ekmA=survfit(Surv(IDADEanos,censura_suicidio)~1, conf.type="log-log", data = base)
summary(ekmA)

autoplot(ekmA) +
  labs(x = "Tempo (anos)",
       y = "S(t) estimada")
```

## Curvas de Sobrevivência Estratificadas

## Sexo
```{r, message=F, warning=F}
ekm_sexo = survfit(Surv(IDADEanos,censura_suicidio)~SEXO, data = base)
summary(ekm_sexo)

sex = autoplot(ekm_sexo) +
  labs(title = "Sexo",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
sex
```


## Assistência Médica
```{r, message=F, warning=F}
ekm_assistmed = survfit(Surv(IDADEanos,censura_suicidio)~ASSISTMED)
summary(ekm_assistmed)
# plot(ekm_assistmed, col=c(2, 1), xlab="Tempo (anos)",ylab="S(t) estimada")
# legend(1,0.5,col=c(2, 1),c("Não","Sim"),lwd=1, bty="n")

am = autoplot(ekm_assistmed) +
  labs(title = "Assistencia Médica",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
am
```

## Região do País
```{r, message=F, warning=F}
ekm_reg = survfit(Surv(IDADEanos,censura_suicidio)~regiao, 
                  data = base)
summary(ekm_reg)

r = autoplot(ekm_reg) +
  labs(title = "Região",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
r
```

## Flag SP
```{r, message=F, warning=F}
ekm_sp = survfit(Surv(IDADEanos,censura_suicidio)~flag_sp)
summary(ekm_sp)

sp = autoplot(ekm_sp) +
  labs(title = "Flag SP",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
sp
```


## Flag PB
```{r, message=F, warning=F}
ekm_pb = survfit(Surv(IDADEanos,censura_suicidio)~flag_pb)
summary(ekm_pb)

pb = autoplot(ekm_pb) +
  labs(title = "Flag PB",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
pb
```

## Faixa Etária
```{r, message=F, warning=F}
ekm_fxetaria = survfit(Surv(IDADEanos,censura_suicidio)~faixa_etaria)
summary(ekm_fxetaria)

fxetaria = autoplot(ekm_fxetaria) +
  labs(title = "Faixa Etária",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
fxetaria
```

## Ano do Óbito
```{r, message=F, warning=F}
ekm_ano = survfit(Surv(IDADEanos,censura_suicidio)~ano)
summary(ekm_ano)

a = autoplot(ekm_ano) +
  labs(title = "Ano",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
a
```

## Estado Civil
```{r, message=F, warning=F}
ekm_estciv = survfit(Surv(IDADEanos, censura_suicidio)~ESTCIV)
summary(ekm_estciv)

ec = autoplot(ekm_estciv) +
  labs(title = "Estado Civil",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
ec
```

## Local do Óbito
```{r, message=F, warning=F}
ekm_local = survfit(Surv(IDADEanos, censura_suicidio)~LOCOCOR)
summary(ekm_local)

loc = autoplot(ekm_local) +
  labs(title = "Local da Ocorrência",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
loc
```

## Raça/Cor
```{r, message=F, warning=F}
ekm_cor = survfit(Surv(IDADEanos, censura_suicidio)~RACACOR)
summary(ekm_cor)

cor = autoplot(ekm_cor) +
  labs(title = "Raça/Cor",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
cor
```


## Trimestre
```{r, message=F, warning=F}
ekm_tri = survfit(Surv(IDADEanos, censura_suicidio)~tri)
summary(ekm_tri)

t = autoplot(ekm_tri) +
  labs(title = "Trimestre",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
t
```

## Flag Aposentado
```{r, message=F, warning=F}
ekm_aposentado = survfit(Surv(IDADEanos, censura_suicidio)~flag_aposentado)
summary(ekm_aposentado)

ap = autoplot(ekm_aposentado) +
  labs(title = "Flag Aposentado",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
ap
```

## Flag Estudante
```{r, message=F, warning=F}
ekm_estudante = survfit(Surv(IDADEanos, censura_suicidio)~flag_estudante)
summary(ekm_estudante)

estudante = autoplot(ekm_estudante) +
  labs(title = "Flag Estudante",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
estudante
```

## Flag Escolaridade
```{r, message=F, warning=F}
ekm_escolaridade = survfit(Surv(IDADEanos, censura_suicidio)~ESC2010)
summary(ekm_escolaridade)

es = autoplot(ekm_escolaridade) +
  labs(title = "Flag Escolaridade",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
es
```

## Flag Necrópsia
```{r, message=F, warning=F}
ekm_necro = survfit(Surv(IDADEanos, censura_suicidio)~NECROPSIA)
summary(ekm_necro)

necro = autoplot(ekm_necro) +
  labs(title = "Necrópsia",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
necro 
```

## Fonte
```{r, message=F, warning=F}
ekm_fonte = survfit(Surv(IDADEanos, censura_suicidio)~FONTE)
summary(ekm_fonte)

fonte = autoplot(ekm_fonte) +
  labs(title = "Fonte",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
fonte 
```

## Flag Residência vs Ocorrência da Morte
```{r, message=F, warning=F}
ekm_morteoco = survfit(Surv(IDADEanos, censura_suicidio)~morteoco)
summary(ekm_morteoco)

moco = autoplot(ekm_morteoco) +
  labs(title = "Flag Ocorrência da Morte vs Residência",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
moco 
```

## Flag Residência vs Naturalidade
```{r, message=F, warning=F}
ekm_mortenatu = survfit(Surv(IDADEanos, censura_suicidio)~mortenatu)
summary(ekm_mortenatu)

mnatu = autoplot(ekm_mortenatu) +
  labs(title = "Flag Ocorrência da Morte vs Naturalidade",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
mnatu
```

## Flag Pandemia
```{r, message=F, warning=F}
ekm_pandemia = survfit(Surv(IDADEanos, censura_suicidio)~pandemia)
summary(ekm_pandemia)

pan = autoplot(ekm_pandemia) +
  labs(title = "Flag Pandemia",
       x = "Tempo (anos)", y = "S(t) estimada") +
  theme_bw()
pan
```

# Estimativa de Mediana
```{r, message=F, warning=F}
ekm
ekm_ano
ekm_aposentado
ekm_assistmed
ekm_cor
ekm_escolaridade
ekm_estciv
ekm_estudante
ekm_fonte
ekm_fxetaria
ekm_local
ekm_mortenatu
ekm_morteoco
ekm_necro
ekm_pandemia
ekm_pb
ekm_reg
ekm_sexo
ekm_sp
ekm_tri
```

# Estimativa de Tempo Médio
```{r, message=F, warning=F}
t= IDADEanos[censura_suicidio==1]
tj=c(0,as.numeric(levels(as.factor(t))))
surv=c(1,as.numeric(levels(as.factor(ekm$surv))))
surv=sort(surv, decreasing=T)
k=length(tj)-1
prod=matrix(0,k,1)
for(j in 1:k){
  prod[j]=(tj[j+1]-tj[j])*surv[j]
}
tm=sum(prod)
tm
```

# Estimação da Função de Risco
```{r, message=F, warning=F}
risco= pehaz(IDADEanos,censura_suicidio)
objects(risco)
risco$Hazard
plot(risco)
```

# Comparação das Curvas de Sobrevivência

## Ano do Óbito
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~ano,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~ano,rho=1)
```

p-valores < 0,05, rejeitamos a hipótese nula, logo existe diferença significativa entra os anos.

## Sexo
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~SEXO,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~SEXO,rho=1)
```

p-valores < 0,05, rejeitamos a hipótese nula, logo existe diferença significativa entra os sexos.

## Raça/Cor
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~RACACOR,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~RACACOR,rho=1)
```

p-valores < 0,05, rejeitamos a hipótese nula, logo existe diferença significativa entra as raças/cor.

## Estado Civil
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~ESTCIV,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~ESTCIV,rho=1)
```

p-valores < 0,05, rejeitamos a hipótese nula, logo existe diferença significativa entra os estados civis.

## Local de Ocorrência
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~LOCOCOR,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~LOCOCOR,rho=1)
```

p-valores < 0,05, rejeitamos a hipótese nula, logo existe diferença significativa entra os locais de ocorrência do óbito.

## Assistência Médica
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~ASSISTMED,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~ASSISTMED,rho=1)
```

p-valores < 0,05, rejeitamos a hipótese nula, logo existe diferença significativa entre ter tido ou não assistência médica.


## Região
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~regiao,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~regiao,rho=1)
```

p-valores < 0,05, rejeitamos a hipótese nula, logo existe diferença significativa entre as regiões do Brasil.


## Flag Estudante
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~flag_estudante,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~flag_estudante,rho=1)
```

p-valores < 0,05, rejeitamos a hipótese nula, logo existe diferença significativa entre ser ou não estudante.

## Flag SP
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~flag_sp,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~flag_sp,rho=1)
```

p-valores < 0,05, rejeitamos a hipótese nula, logo existe diferença significativa entre ser ou não do Estado de São Paulo.

## Flag PB
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~flag_pb,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~flag_pb,rho=1)
```

p-valores > 0,05, não rejeitamos a hipótese nula, logo não existe diferença significativa entre ser ou não do Estado da Paraíba.

## Flag Aposentado
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~flag_aposentado,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~flag_aposentado,rho=1)
```

p-valores < 0,05, rejeitamos a hipótese nula, logo existe diferença significativa entre ser ou não aposentado.


## Trimestre
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~tri,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~tri,rho=1)
```

p-valores < 0,05, rejeitamos a hipótese nula, logo existe diferença significativa entre os trimestres


## Faixa Etária
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~faixa_etaria,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~faixa_etaria,rho=1)
```

p-valores < 0,05, rejeitamos a hipótese nula, logo existe diferença significativa entre as faixas etárias.

## Escolaridade
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~ESC2010,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~ESC2010,rho=1)
```

p-valores < 0,05, rejeitamos a hipótese nula, logo existe diferença significativa entre ser os níveis de escolaridade

## Faixa Necrópsia
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~NECROPSIA,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~NECROPSIA,rho=1)
```

p-valores < 0,05, rejeitamos a hipótese nula, logo existe diferença significativa entre ter sido necropsiado o corpo ou não

## Fonte
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~FONTE,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~FONTE,rho=1)
```

p-valores < 0,05, rejeitamos a hipótese nula, logo existe diferença significativa entre as fontes de informação

## Residencia vs Ocorrência
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~morteoco,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~morteoco,rho=1)
```

p-valores < 0,05, rejeitamos a hipótese nula, logo existe diferença significativa entre a ocorrência da morte ser no mesmo municipio de residencia.

## Residencia vs Naturalidade
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~mortenatu,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~mortenatu,rho=1)
```

p-valores < 0,05, rejeitamos a hipótese nula, logo existe diferença significativa entre a ocorrência da morte ser no mesmo municipio de naturalidade.

## Pandemia
```{r, message=F, warning=F}
survdiff(Surv(IDADEanos,censura_suicidio)~pandemia,rho=0)
survdiff(Surv(IDADEanos,censura_suicidio)~pandemia,rho=1)
```

p-valores < 0,05, rejeitamos a hipótese nula, logo existe diferença significativa entre o óbito ter ocorrido na pandemia ou não

# Ajustes Paramétricos

## Exponencial

Ajuste do ajusteln:

```{r, message=F, warning=F}
ajust1=survreg(Surv(IDADEanos,censura_suicidio)~1,dist='exponential')
ajust1
```

Estimação do parâmetro:

```{r, message=F, warning=F}
lambda=exp(ajust1$coefficients[1])
lambdae=1/lambda
lambdae
```

Tempo médio:

```{r, message=F, warning=F}
tme=1/lambdae
tme
```

Percentil (aqui usando Mediana):

```{r, message=F, warning=F}
p = 0.5
tpe=(-log(1-p))/lambdae
tpe
```

## Weibull

Ajuste do ajusteln:

```{r, message=F, warning=F}
ajust2=survreg(Surv(IDADEanos,censura_suicidio)~1,dist='weibull')
ajust2
```

Estimação dos parâmetros:

```{r, message=F, warning=F}
lambda1=exp(ajust2$coefficients[1])
lambdaw=1/lambda1
gama=1/ajust2$scale
cbind(gama, lambdaw)
```

Tempo médio:

```{r, message=F, warning=F}
tmw=(gamma(1+(1/gama)))/lambdaw
tmw
```

Percentil (aqui usando Mediana):

```{r, message=F, warning=F}
p = 0.5
tpw=(-log(1-p))^(1/gama)/lambdaw
tpw
```

## Lognormal

Ajuste do ajusteln:

```{r, message=F, warning=F}
ajust3=survreg(Surv(IDADEanos,censura_suicidio)~1,dist='lognorm')
ajust3
```

Estimação do parâmetro:

```{r, message=F, warning=F}
mu= ajust3$coefficients
sigma= ajust3$scale
cbind(mu,sigma)
```

Tempo médio:

```{r, message=F, warning=F}
tml=exp(mu+sigma^2/2)
tml
```

Percentil (aqui usando Mediana):

```{r, message=F, warning=F}
p = 0.5
zp=qnorm(1-p)
tpl=exp(zp*sigma+mu)
tpl
```

## Comparação das distribuições

Obtendo as estimativas das funções de sobrevivência para as técnicas utilizadas:

```{r, message=F, warning=F}
ekm=survfit(Surv(IDADEanos,censura_suicidio)~1)
time=ekm$time
st=ekm$surv
ste= exp(-time*lambdae) 
stw= exp(-(time*lambdaw)^gama)
stln= pnorm((-log(time)+ mu)/sigma)

```

```{r, echo=FALSE, message=F, warning=F}
dados = cbind(time,st,ste,stw,stln) %>% data.frame()
knitr::kable(dados, col.names = c("Tempos", "S(t) Kaplan-Meier", "S(t) Exponencial",
                                  "S(t) Weibull", "S(t) Lognormal"))
```

Métodos gráficos para escolha da melhor distribuição:

- Método gráfico 1:

```{r, echo=FALSE, message=F, warning=F}
par(mfrow=c(1,3))
plot(ste,st,pch=16,ylim=range(c(0.0,1)), xlim=range(c(0,1)), ylab = "S(t): Kaplan-Meier",
xlab="S(t): exponencial")
lines(c(0,1), c(0,1), type="l", lty=1)
plot(stw,st,pch=16,ylim=range(c(0.0,1)), xlim=range(c(0,1)), ylab = "S(t): Kaplan-Meier",
xlab="S(t): Weibull")
lines(c(0,1), c(0,1), type="l", lty=1)
plot(stln,st,pch=16,ylim=range(c(0.0,1)), xlim=range(c(0,1)), ylab = "S(t): Kaplan-Meier",
xlab="S(t): log-normal")
lines(c(0,1), c(0,1), type="l", lty=1)

par(mfrow=c(1,3))
plot(ekm, conf.int=F, xlab="Tempos", ylab="S(t)")
lines(c(0,time),c(1,ste), lty=2)
legend(25,0.8,lty=c(1,2),c("Kaplan-Meier", "Exponencial"),bty="n",cex=0.8)
plot(ekm, conf.int=F, xlab="Tempos", ylab="S(t)")
lines(c(0,time),c(1,stw), lty=2)
legend(25,0.8,lty=c(1,2),c("Kaplan-Meier", "Weibull"),bty="n",cex=0.8)
plot(ekm, conf.int=F, xlab="Tempos", ylab="S(t)")
lines(c(0,time),c(1,stln), lty=2)
legend(25,0.8,lty=c(1,2),c("Kaplan-Meier", "Log-normal"),bty="n",cex=0.8)
```

Pela análise deste metódo gráfico, temos que a distribuição **Lognormal** é a que melhor os dados se adaptam.

- Método Gráfico 2:

Para a aplicação deste método é necessário fazer a linearização das funções de sobrevivência:

```{r, message=F, warning=F}
lste=-log(st)
lstw=log(-log(st))
lstln=qnorm(st)
```

<!-- Como o ultimo tempo do nosso banco é censura, ou seja `censura_suicidio = 0`, não é possível aplicar o método gráfico 2. Usaremos a distribuição Weibull como indicado pelo método anterior.  -->

as sobrevivências apresentam valores -inf. pelo grafico vai ser lognomal

Teste da Razão de Verossimilhanças:

```{r, message=F, warning=F}
fitgg = flexsurvreg(formula = Surv(IDADEanos, censura_suicidio) ~ 1,dist="gengamma")
fitw = flexsurvreg(formula = Surv(IDADEanos, censura_suicidio) ~ 1, dist="weibull")
fite = flexsurvreg(formula = Surv(IDADEanos, censura_suicidio) ~ 1, dist="exp")
fitl = flexsurvreg(formula = Surv(IDADEanos, censura_suicidio) ~ 1, dist="lnorm")

loglikm1=fite$loglik[1]  #log-verossimilhança ajusteln exponencial	
loglikm2=fitw$loglik[1]  #log-verossimilhança ajusteln weibull
loglikm3=fitl$loglik[1]  #log-verossimilhança ajusteln lognormal
loglikG=fitgg$loglik[1]  #log-verossimilhança ajusteln generalizado 

RVe=2*(loglikG-loglikm1) #Estatística da razão de verossimilhanças para o ajusteln exponencial
RVw=2*(loglikG-loglikm2) #Estatística da razão de verossimilhanças para o ajusteln weibull
RVln=2*(loglikG-loglikm3)#Estatística da razão de verossimilhanças para o ajusteln lognormal

pRV1=1-pchisq(RVe,2) #Exponencial
pRV2=1-pchisq(RVw,1) #Weibull
pRV3=1-pchisq(RVln,1) #Lognormal
```

```{r, echo=FALSE, message=F, warning=F}
dados = cbind(pRV1, pRV2, pRV3) %>% data.frame()
knitr::kable(dados, col.names = c("p-valor Exponencial", "p-valor Weibull", "p-valor Lognormal"))
```

p-valores iguais a 0 podem ser explicados pelo alto volume de dados.

# Ajuste do Modelo de Regressão

```{r, message=F, warning=F}
base_ln = copy(base) 
ajusteln = survreg(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri) +
                    factor(pandemia), 
                  dist = 'lognorm', data = base_ln)

summary(ajusteln) 
```

## Seleção das variáveis pelo p-valor:

```{r, message=F, warning=F}
base_ln$ano[base_ln$ano=="2020"] = "2014"

ajusteln = survreg(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri) +
                    factor(pandemia), 
                  dist = 'lognorm', data = base_ln)

summary(ajusteln)
```

```{r, message=F, warning=F}
base_ln$tri[base_ln$tri == "2º Tri"] = "1º Tri"

ajusteln = survreg(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri) +
                    factor(pandemia), 
                  dist = 'lognorm', data = base_ln)

summary(ajusteln)
```

```{r, message=F, warning=F}
base_ln$ano[base_ln$ano == "2015"] = "2014"

ajusteln = survreg(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri) +
                    factor(pandemia), 
                  dist = 'lognorm', data = base_ln)

summary(ajusteln)
```

```{r, message=F, warning=F}
base_ln$ESTCIV[base_ln$ESTCIV == "União consensual"] = "Casado"

ajusteln = survreg(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri) +
                    factor(pandemia), 
                  dist = 'lognorm', data = base_ln)

summary(ajusteln)
```

```{r, message=F, warning=F}
base_ln$ano[base_ln$ano == "2017"] = "2014"

ajusteln = survreg(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri) +
                    factor(pandemia), 
                  dist = 'lognorm', data = base_ln)

summary(ajusteln)
```

```{r, message=F, warning=F}
base_ln$ano[base_ln$ano == "2016"] = "2014"

ajusteln = survreg(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri) +
                    factor(pandemia), 
                  dist = 'lognorm', data = base_ln)

summary(ajusteln)
```

```{r, message=F, warning=F}
base_ln$LOCOCOR[base_ln$LOCOCOR == "Domicílio"] = "Aldeia Indígena"

ajusteln = survreg(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri) +
                    factor(pandemia), 
                  dist = 'lognorm', data = base_ln)

summary(ajusteln)
```

```{r, message=F, warning=F}
base_ln$RACACOR[base_ln$RACACOR == "Preta"] = "Amarela"

ajusteln = survreg(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri) +
                    factor(pandemia), 
                  dist = 'lognorm', data = base_ln)

summary(ajusteln)
```

Chegando assim no ajusteln final, ficando com 19 variáveis.

## Análise de Resíduos

### Cox - Snell

```{r, message=F, warning=F}
dummies = base_ln %>% 
  mutate(sexo = ifelse(SEXO == "Masculino", 1, 0),
         racacor_b = ifelse(RACACOR == "Branca", 1, 0),
         racacor_pa = ifelse(RACACOR == "Parda", 1, 0),
         racacor_i = ifelse(RACACOR == 'Indígena', 1, 0),
         estciv_s = ifelse(ESTCIV == 'Solteiro', 1, 0),
         estciv_sj = ifelse(ESTCIV == 'Separado judicialmente', 1, 0),
         estciv_v = ifelse(ESTCIV == 'Viúvo', 1, 0),
         lococor_h = ifelse(LOCOCOR == 'Hospital', 1, 0),
         lococor_os = ifelse(LOCOCOR == 'Outro estabelecimento de saúde', 1, 0),
         lococor_o = ifelse(LOCOCOR == 'Outros', 1, 0),
         lococor_vp = ifelse(LOCOCOR == 'Via pública', 1, 0),
         esc1 = ifelse(ESC2010 == '1', 1, 0),
         esc2 = ifelse(ESC2010 == '2', 1, 0),
         esc3 = ifelse(ESC2010 == '3', 1, 0),
         esc4 = ifelse(ESC2010 == '4', 1, 0),
         esc5 = ifelse(ESC2010 == '5', 1, 0),
         esc9 = ifelse(ESC2010 == '9', 1, 0),
         necro = ifelse(NECROPSIA == "Sim", 1, 0),
         fonte_f = ifelse(FONTE == 'Família', 1, 0),
         fonte_o = ifelse(FONTE == 'Outro', 1, 0),
         fonte_h = ifelse(FONTE == 'Hospital', 1, 0),
         regiao_nd = ifelse(regiao == 'Nordeste', 1, 0),
         regiao_nt = ifelse(regiao == 'Norte', 1, 0),
         regiao_sd = ifelse(regiao == 'Sudeste', 1, 0),
         regiao_s = ifelse(regiao == 'Sul', 1, 0),
         ano_2018 = ifelse(ano == '2018', 1, 0),
         ano_2019 = ifelse(ano == '2019', 1, 0),
         ano_2021 = ifelse(ano == '2021', 1, 0),
         fx_20a39 = ifelse(faixa_etaria == '20 a 39 anos', 1, 0),
         fx_40a59 = ifelse(faixa_etaria == '40 a 59 anos', 1, 0),
         fx_05a14 = ifelse(faixa_etaria == '5 a 14 anos', 1, 0),
         fx_60 = ifelse(faixa_etaria == '60 anos ou mais', 1, 0),
         tri_3 = ifelse(tri == '3º Tri', 1, 0),
         tri_4 = ifelse(tri == '4º Tri', 1, 0),
         assist = ifelse(ASSISTMED == "Sim", 1, 0)) %>% 
  select(sexo, racacor_b, racacor_i, racacor_pa, estciv_sj, estciv_s,
         estciv_v, lococor_h, lococor_os, lococor_o, lococor_vp, assist,
         esc1, esc2, esc3, esc4, esc5, esc9, necro, fonte_f, fonte_h, fonte_o,
         morteoco, mortenatu, regiao_nd, regiao_nt, regiao_sd, regiao_s,
         ano_2018, ano_2019, ano_2021, flag_aposentado,
         flag_estudante, flag_pb, flag_sp, fx_20a39, fx_40a59, fx_05a14, fx_60,
         tri_3, tri_4, pandemia)


coefs = ajusteln$coefficients
  
xb <- coefs[1] + 
  coefs[2] * dummies$sexo + 
  coefs[3] * dummies$racacor_b + 
  coefs[4] * dummies$racacor_i + 
  coefs[5] * dummies$racacor_pa + 
  coefs[6] * dummies$estciv_sj +
  coefs[7] * dummies$estciv_s +
  coefs[8] * dummies$estciv_v +
  coefs[9] * dummies$lococor_h +
  coefs[10] * dummies$lococor_os +
  coefs[11] * dummies$lococor_o +
  coefs[12] * dummies$lococor_vp +
  coefs[13] * dummies$assist +
  coefs[14] * dummies$esc1 +
  coefs[15] * dummies$esc2 +
  coefs[16] * dummies$esc3 +
  coefs[17] * dummies$esc4 +
  coefs[18] * dummies$esc5 +
  coefs[19] * dummies$esc9 +
  coefs[20] * dummies$necro +
  coefs[21] * dummies$fonte_f +
  coefs[22] * dummies$fonte_h +
  coefs[23] * dummies$fonte_o +
  coefs[24] * dummies$morteoco +
  coefs[25] * dummies$mortenatu +
  coefs[26] * dummies$regiao_nd +
  coefs[27] * dummies$regiao_nt +
  coefs[28] * dummies$regiao_sd +
  coefs[29] * dummies$regiao_s +
  coefs[30] * dummies$ano_2018 +
  coefs[31] * dummies$ano_2019 +
  coefs[32] * dummies$ano_2021 +
  coefs[33] * dummies$flag_aposentado +
  coefs[34] * dummies$flag_estudante +
  coefs[35] * dummies$flag_pb +
  coefs[36] * dummies$flag_sp +
  coefs[37] * dummies$fx_20a39 +
  coefs[38] * dummies$fx_40a59 +
  coefs[39] * dummies$fx_05a14 +
  coefs[40] * dummies$fx_60 +
  coefs[41] * dummies$tri_3 +
  coefs[42] * dummies$tri_4 +
  coefs[43] * dummies$pandemia
      
sigma = ajusteln$scale
res = (log(IDADEanos)-xb)/sigma
ei = -log(1-pnorm(res))
ekm = survfit(Surv(ei,censura_suicidio)~1)
t = ekm$time # são os resíduos
st = ekm$surv
sexp = exp(-t)

par(mfrow=c(1,2))
plot(st,sexp,xlab="S(ei): Kaplan-Meier", ylab= "S(ei):Exponencial(1)",pch=16)
abline(lm(sexp ~ st))
plot(ekm, conf.int=F,xlab="residuos de Cox Snell",ylab="S(t) estimada")
lines(t,sexp,lty=3)
legend("topright",lty=c(1,3),c("Kaplan-Meier","Exponencial(1)"),
       lwd=1, bty="n", cex=0.8)
```

### Deviance

```{r, message=F, warning=F}
resid.deviance<-residuals(ajusteln,type="deviance")
index<-1:length(IDADEanos)
par(mfrow = c(1,1))
plot(resid.deviance~index)
```

### Padronizado

```{r, message=F, warning=F}
res<-(log(IDADEanos)-xb)/sigma
resid<-exp(res)
ekm1<-survfit(Surv(resid,censura_suicidio)~1)
resid<-ekm1$time
sln<-pnorm(-log(resid))

par(mfrow=c(1,2))
plot(ekm1$surv,sln,xlab="S(nui): Kaplan-Meier", ylab= "S(nui):Log-Normal Padrão(1)",pch=16)
abline(lm(sln ~ ekm1$surv))
plot(ekm1, conf.int=F,xlab="residuos Padronizado",ylab="Sobrevivência estimada")
lines(resid,sln,lty=2)
legend("topright",lty=c(1,2),c("Kaplan-Meier","Log-Normal Padrão"),lwd=1, bty="n", cex=0.8)
```

Analisando as avaliações do modelo, essa abordagem se adapta bem.

## Teste de Adequação do Modelo

```{r, message=F, warning=F}
# ln = flexsurvreg(Surv(IDADEanos, censura_suicidio)~ 
#                     factor(SEXO) +
#                     factor(RACACOR) +
#                     factor(ESTCIV) +
#                     factor(LOCOCOR) + 
#                     factor(ASSISTMED) +
#                     factor(ESC2010) +
#                     factor(NECROPSIA) +
#                     factor(FONTE) +
#                     factor(morteoco) +
#                     factor(mortenatu) +
#                     factor(regiao) +
#                     factor(ano) +
#                     factor(flag_aposentado) +
#                     factor(flag_estudante) +
#                     factor(flag_pb) +
#                     factor(flag_sp) +
#                     factor(faixa_etaria) +
#                     factor(tri) +
#                     factor(pandemia), 
#                   dist = 'lnorm', data = base_ln, x = T)
# 
# base_ln$lp = predict(ajusteln, type = 'lp')
# 
# ROC_curve = risksetROC::risksetROC(Stime = base_ln$IDADEanos, 
#                                    status = base_ln$censura_suicidio,
#                                    marker = base_ln$lp,
#                                    method = 'Schoenfeld',
#                                    span = 0.25*nrow(base_ln)^(-0.20),
#                                    main="ROC Curve", lty=2, col="red")

# span: usei o que encontrei em pesquisas, entender pq esse valor

```

# Ajuste do Modelo de Cox

```{r, message=F, warning=F}
base_cox = copy(base)

ajustecox = coxph(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri) +
                    factor(pandemia), data = base_cox)
                  
summary(ajustecox)
```

## Seleção de Variáveis

```{r, message=F, warning=F}
ajustecox = coxph(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri), data = base_cox)
                  
summary(ajustecox)
```

```{r, message=F, warning=F}
base_cox$faixa_etaria[base_cox$faixa_etaria == "5 a 14 anos"] = "15 a 19 anos"

ajustecox = coxph(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri), data = base_cox)
                  
summary(ajustecox)
```

```{r, message=F, warning=F}
base_cox$faixa_etaria[base_cox$faixa_etaria == "20 a 39 anos"] = "15 a 19 anos"

ajustecox = coxph(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri), data = base_cox)
                  
summary(ajustecox)
```

```{r, message=F, warning=F}
base_cox$tri[base_cox$tri=="2º Tri"] = "1º Tri"

ajustecox = coxph(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri), data = base_cox)
                  
summary(ajustecox)
```

```{r, message=F, warning=F}
base_cox$ano[base_cox$ano == "2017"] = "2014"

ajustecox = coxph(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri), data = base_cox)
                  
summary(ajustecox)
```

```{r, message=F, warning=F}
base_cox$faixa_etaria[base_cox$faixa_etaria == "40 a 59 anos"] = "15 a 19 anos"

ajustecox = coxph(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri), data = base_cox)
                  
summary(ajustecox)
```

```{r, message=F, warning=F}
ajustecox = coxph(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(tri), data = base_cox)
                  
summary(ajustecox)
```

```{r, message=F, warning=F}
base_cox$ano[base_cox$ano == "2015"] = "2014"

ajustecox = coxph(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(tri), data = base_cox)
                  
summary(ajustecox)
```

```{r, message=F, warning=F}
base_cox$ano[base_cox$ano == "2018"] = "2014"

ajustecox = coxph(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(tri), data = base_cox)
                  
summary(ajustecox)
```

```{r, message=F, warning=F}
base_cox$tri[base_cox$tri == "3º Tri"] = "1º Tri"

ajustecox = coxph(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(tri), data = base_cox)
                  
summary(ajustecox)
```

```{r, message=F, warning=F}
ajustecox = coxph(Surv(IDADEanos, censura_suicidio)~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp), data = base_cox)
                  
summary(ajustecox)
```

Chegando assim no modelo final, ficando com 16 variáveis.

## Analise Grafica para verificar proporcionalidade dos riscos

<!-- ### Teste -->

<!-- Não funcionou muito bem, estudar um pouco sobre como separar para apresentar menos variáveis por quadro. Tentar usar esse para substituir tópico a seguir. -->

<!-- ```{r} -->
<!-- teste = aareg(Surv(IDADEanos, censura_suicidio)~  -->
<!--                     factor(SEXO) + -->
<!--                     factor(RACACOR) + -->
<!--                     factor(ESTCIV) + -->
<!--                     factor(LOCOCOR) +  -->
<!--                     factor(ASSISTMED) + -->
<!--                     factor(ESC2010) + -->
<!--                     factor(NECROPSIA) + -->
<!--                     factor(FONTE) + -->
<!--                     factor(morteoco) + -->
<!--                     factor(mortenatu) + -->
<!--                     factor(regiao) + -->
<!--                     factor(ano) + -->
<!--                     factor(flag_aposentado) + -->
<!--                     factor(flag_estudante) + -->
<!--                     factor(flag_pb) + -->
<!--                     factor(flag_sp), data = base_cox) -->

<!-- autoplot(teste) + -->
<!--   theme(legend.position = "none") -->
<!-- ``` -->


### Grafico dos residuos Schoenfeld proporcionalidade

```{r, message=F, warning=F, out.width="50%"}
plot(cox.zph(ajustecox))
```

### Teste de Proporcionalidade

```{r, message=F, warning=F}
cox.zph(ajustecox)
```

Não passa no teste de proporcionalidade.

### Gráfico dos resíduos Deviance e Martingal

```{r, message=F, warning=F}
par(mfrow = c(1,2))
mart<-resid(ajustecox,type="martingale")
dev<-resid(ajustecox,type="deviance")
plot(mart,ylab="res",pch=20) 
title("Resíduos Martingal")
plot(dev,ylab="res",pch=20)	 
title("Resíduos Deviance")
```

### Grafico do ajuste de Cox

```{r, message=F, warning=F}
autoplot(survfit(ajustecox)) +
  labs(y = "S(t) estimada",
       x = "Idade (anos)",
       title = "Sobrevivência do ajuste de Cox") +
  theme(legend.position = 'none')
```


# Modelo de Risco Competitivo

Para aplicação deste método é necessário reorganizar o banco de dados e a coluna de censura. Para o banco em estudo todos os individuos morreram, logo nossa censura será toda 1, e iremos criar a coluna de risco competitivo onde cada tipo de morte não natural vai receber um valor como descrito abaixo:

- Suicidio = 1
- Homicidio = 2
- Acidente = 3
- Outro = 0

```{r, message=F, warning=F}
base_rc = base %>% 
  mutate(id = 1:nrow(base)) %>% 
  select(-censura_suicidio)
base_rc2 = copy(base_rc)
base_rc3 = copy(base_rc)

summary(base_rc)
```
## Sobrevivências

```{r, message=F, warning=F}
acumulado = cuminc(Surv(IDADEanos, censura_rc) ~ 1, data = base_rc %>% mutate(censura_rc = factor(censura_rc)))
acumulado
```

## FIA

testar como fica usando um por vez, pq tem muito mais observações a causa 1 (suicidio)

```{r, message=F, warning=F}
acumulado %>% 
  ggcuminc(outcome = c("1", "2", "3")) +
  ylim(c(0, 1)) + 
  labs(
    x = "Idade (em anos)",
    y = "Incidencia Cumulativa"
  ) + 
  add_confidence_interval() +
  add_risktable()

acumulado %>% 
  ggcuminc(outcome = "1") +
  ylim(c(0, 1)) + 
  labs(
    x = "Idade (em anos)",
    y = "Incidencia Cumulativa"
  ) + 
  add_confidence_interval() +
  add_risktable()

acumulado %>% 
  ggcuminc(outcome = "2") +
  ylim(c(0, 1)) + 
  labs(
    x = "Idade (em anos)",
    y = "Incidencia Cumulativa"
  ) + 
  add_confidence_interval() +
  add_risktable()

acumulado %>% 
  ggcuminc(outcome = "3") +
  ylim(c(0, 1)) + 
  labs(
    x = "Idade (em anos)",
    y = "Incidencia Cumulativa"
  ) + 
  add_confidence_interval() +
  add_risktable()
```


## Modelo para suicidio

```{r, message=F, warning=F}
a = names(base_rc)
pesos_rc1 = crprep(Tstop="IDADEanos",status="CIRCOBITO",trans=1:3,
               id = "id", keep=a, data=base_rc)


ajusterc = coxph(Surv(Tstart, Tstop, CIRCOBITO=="Suicídio")~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri) +
                    factor(pandemia), 
                 data = pesos_rc1, subset = failcode==1, 
                 weights = weight.cens)

ajusterc
```

```{r, message=F, warning=F}
pesos_rc1$faixa_etaria[pesos_rc1$faixa_etaria=="5 a 14 anos"] = "15 a 19 anos"

ajusterc = coxph(Surv(Tstart, Tstop, CIRCOBITO=="Suicídio")~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri) +
                    factor(pandemia), 
                 data = pesos_rc1, subset = failcode==1, 
                 weights = weight.cens)

ajusterc
```

```{r, message=F, warning=F}
ajusterc = coxph(Surv(Tstart, Tstop, CIRCOBITO=="Suicídio")~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri), 
                 data = pesos_rc1, subset = failcode==1, 
                 weights = weight.cens)

ajusterc
```

```{r, message=F, warning=F}
pesos_rc1$faixa_etaria[pesos_rc1$faixa_etaria=="20 a 39 anos"] = "15 a 19 anos"

ajusterc = coxph(Surv(Tstart, Tstop, CIRCOBITO=="Suicídio")~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri), 
                 data = pesos_rc1, subset = failcode==1, 
                 weights = weight.cens)

ajusterc
```

```{r, message=F, warning=F}
pesos_rc1$tri[pesos_rc1$tri == "2º Tri"] = "1º Tri"

ajusterc = coxph(Surv(Tstart, Tstop, CIRCOBITO=="Suicídio")~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri), 
                 data = pesos_rc1, subset = failcode==1, 
                 weights = weight.cens)

ajusterc
```

```{r, message=F, warning=F}
pesos_rc1$faixa_etaria[pesos_rc1$faixa_etaria=="40 a 59 anos"] = "15 a 19 anos"

ajusterc = coxph(Surv(Tstart, Tstop, CIRCOBITO=="Suicídio")~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(faixa_etaria) +
                    factor(tri), 
                 data = pesos_rc1, subset = failcode==1, 
                 weights = weight.cens)

ajusterc
```

```{r, message=F, warning=F}
ajusterc = coxph(Surv(Tstart, Tstop, CIRCOBITO=="Suicídio")~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(tri), 
                 data = pesos_rc1, subset = failcode==1, 
                 weights = weight.cens)

ajusterc
```

```{r, message=F, warning=F}
pesos_rc1$ano[pesos_rc1$ano=="2018"] = "2014"

ajusterc = coxph(Surv(Tstart, Tstop, CIRCOBITO=="Suicídio")~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(tri), 
                 data = pesos_rc1, subset = failcode==1, 
                 weights = weight.cens)

ajusterc
```

```{r, message=F, warning=F}
pesos_rc1$ano[pesos_rc1$ano=="2015"] = "2014"

ajusterc = coxph(Surv(Tstart, Tstop, CIRCOBITO=="Suicídio")~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(tri), 
                 data = pesos_rc1, subset = failcode==1, 
                 weights = weight.cens)

ajusterc
```

```{r, message=F, warning=F}
pesos_rc1$tri[pesos_rc1$tri=="3º Tri"] = "1º Tri"

ajusterc = coxph(Surv(Tstart, Tstop, CIRCOBITO=="Suicídio")~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(tri), 
                 data = pesos_rc1, subset = failcode==1, 
                 weights = weight.cens)

ajusterc
```

```{r, message=F, warning=F}
pesos_rc1$ano[pesos_rc1$ano=="2017"] = "2014"

ajusterc = coxph(Surv(Tstart, Tstop, CIRCOBITO=="Suicídio")~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp) +
                    factor(tri), 
                 data = pesos_rc1, subset = failcode==1, 
                 weights = weight.cens)

ajusterc
```

```{r, message=F, warning=F}
ajusterc = coxph(Surv(Tstart, Tstop, CIRCOBITO=="Suicídio")~ 
                    factor(SEXO) +
                    factor(RACACOR) +
                    factor(ESTCIV) +
                    factor(LOCOCOR) + 
                    factor(ASSISTMED) +
                    factor(ESC2010) +
                    factor(NECROPSIA) +
                    factor(FONTE) +
                    factor(morteoco) +
                    factor(mortenatu) +
                    factor(regiao) +
                    factor(ano) +
                    factor(flag_aposentado) +
                    factor(flag_estudante) +
                    factor(flag_pb) +
                    factor(flag_sp), 
                 data = pesos_rc1, subset = failcode==1, 
                 weights = weight.cens)

ajusterc
```


O modelo final conta com 16 variáveis

### Grafico dos residuos Schoenfeld proporcionalidade

```{r, message=F, warning=F, out.width="25%"}
cox.zph(ajusterc)

plot(cox.zph(ajusterc))
```


